#!/usr/bin/env bash
# version: 2.0.1

set -eo pipefail

export project_name="$1"

if [ -z "${project_name}" ]; then
  echo "Usage: `basename $0` PROJECT_NAME [FILES_PATTERN] [ADDITIONAL_VARIABLES]"
  echo "example: `basename $0` project '/tmp/*.yml' '[{\"A\":\"B\"},{\"A2\":\"B2\"}]'"

  exit 1
fi

files_pattern="$2"
additional_variables="$3"

contents=$(yq e '.trigger-external-project.trigger.project = strenv(project_name)' -n)
contents=$(echo "$contents" | yq e '.trigger-external-project.trigger.strategy = "depend"')

for f in ${files_pattern}; do
  export key="FILE_CONTENT_$(basename "${f}" | tr '-' '_' | tr '.' '_' | tr '[:lower:]' '[:upper:]')_BASE64"
  export file_content_base64=$(cat "${f}" | base64 -w 0)

  if [ ${#file_content_base64} -ge 9999 ]; then
    echo "Error: '${f}' [${key}] files is too big. (max: 9999, current: ${#file_content_base64})" >&2
    exit 1
  fi

  contents=$(echo "$contents" | yq e '.trigger-external-project.variables += {strenv(key):strenv(file_content_base64)}')
done

for row in $(echo "${additional_variables}" | jq -r '.[] | @base64'); do
  export key=$(echo "${row}" | base64 -d | jq -r 'to_entries[0].key')
  export value=$(echo "${row}" | base64 -d | jq -r 'to_entries[0].value')

  contents=$(echo "$contents" | yq e '.trigger-external-project.variables += {strenv(key):strenv(value)}')
done

echo "$contents"